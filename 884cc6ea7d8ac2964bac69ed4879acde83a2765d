docs/plans/test-coverage-plan.md
  80789ebcbd6eba47 1-585
---
{
  "schema_version": "authorship/3.0.0",
  "git_ai_version": "1.0.22",
  "base_commit_sha": "884cc6ea7d8ac2964bac69ed4879acde83a2765d",
  "prompts": {
    "80789ebcbd6eba47": {
      "agent_id": {
        "tool": "claude",
        "id": "1a3139e0-1ceb-49a5-98d5-613bace43e60",
        "model": "claude-opus-4-5-20251101"
      },
      "human_author": "Zachary Davison <zachary.davison@meetsmore.com>",
      "messages": [
        {
          "type": "user",
          "text": "ultrathink and produce a document in docs/plans which outlines our test coverage and what missing tests we need, for both unit, integration, and e2e",
          "timestamp": "2025-12-10T15:14:33.727Z"
        },
        {
          "type": "assistant",
          "text": "I'll analyze the test coverage across the codebase and create a comprehensive document. Let me explore the test structure first.",
          "timestamp": "2025-12-10T15:14:49.104Z"
        },
        {
          "type": "tool_use",
          "name": "Task",
          "input": {
            "description": "Analyze test coverage",
            "prompt": "Thoroughly explore the test coverage in this codebase. I need to understand:\n\n1. All existing test files (unit tests, integration tests, e2e tests)\n2. What modules/components have tests and what they cover\n3. What modules/components are missing tests\n4. The test patterns being used\n\nLook at:\n- packages/matador/src/ for all source files\n- packages/matador/test/ for test files\n- Any *.test.ts files throughout the codebase\n- The architecture in packages/matador/src/ (core/, transport/, topology/, schema/, pipeline/, codec/, retry/, hooks/, types/, errors/)\n\nProvide a detailed breakdown of:\n- Each source module and its corresponding tests\n- Coverage gaps (modules without tests)\n- Types of tests (unit vs integration vs e2e)\n- What specific scenarios are tested vs missing",
            "subagent_type": "Explore"
          },
          "timestamp": "2025-12-10T15:15:15.327Z"
        },
        {
          "type": "assistant",
          "text": "Now let me create the docs/plans directory and write the comprehensive test coverage document.",
          "timestamp": "2025-12-10T15:16:38.810Z"
        },
        {
          "type": "tool_use",
          "name": "Bash",
          "input": {
            "command": "mkdir -p /home/z/Desktop/work/matador/docs/plans",
            "description": "Create docs/plans directory"
          },
          "timestamp": "2025-12-10T15:16:43.981Z"
        },
        {
          "type": "tool_use",
          "name": "Write",
          "input": {
            "content": "# Matador Test Coverage Analysis & Plan\n\nThis document outlines the current test coverage state and identifies gaps that need to be addressed.\n\n## Executive Summary\n\nMatador has **good coverage of outer layers** (transports, codec, topology, schema, retry) but **missing coverage of core orchestration logic** (FanoutEngine, ProcessingPipeline, ShutdownManager, SafeHooks).\n\n| Category     | Coverage | Status     |\n|--------------|----------|------------|\n| Unit Tests   | 7 files  | Partial    |\n| Integration  | 1 file   | Good       |\n| E2E          | 3 files  | Good       |\n\n---\n\n## Current Test Structure\n\n```\npackages/matador/\n├── src/\n│   ├── core/matador.test.ts\n│   ├── codec/rabbitmq-codec.test.ts\n│   ├── retry/standard-policy.test.ts\n│   ├── schema/registry.test.ts\n│   ├── topology/builder.test.ts\n│   ├── transport/local/local-transport.test.ts\n│   └── transport/multi/multi-transport.test.ts\n└── test/\n    ├── integration/matador.integration.test.ts\n    └── e2e/\n        ├── multi-transport.e2e.test.ts\n        ├── rabbitmq-transport.e2e.test.ts\n        └── transport-compliance.e2e.test.ts\n```\n\n---\n\n## Module-by-Module Coverage\n\n### Core Module (`src/core/`)\n\n| File              | Has Tests | Type | Coverage Quality |\n|-------------------|-----------|------|------------------|\n| matador.ts        | Yes       | Unit | Excellent        |\n| fanout.ts         | No        | -    | Missing          |\n| shutdown.ts       | No        | -    | Missing          |\n\n#### matador.test.ts - What's Covered\n\n- Configuration & initialization\n- Event registration (single & multiple events)\n- Start/connect lifecycle (idempotency, error handling)\n- Send functionality (single subscriber, multiple subscribers, fanout)\n- Shorthand send API (EventClass + data)\n- Correlation ID propagation\n- Shutdown (graceful, idempotency, rejection during shutdown)\n- Idle state tracking\n- Queue consumption\n\n#### FanoutEngine - Missing Tests\n\n```typescript\n// Required test scenarios:\n- send() with single subscriber\n- send() with multiple subscribers\n- Metadata merging into envelope\n- Filtering disabled subscribers via enabled hook\n- Error handling when transport.send fails\n- eventsBeingEnqueuedCount tracking (increment/decrement)\n- Correlation ID propagation through fanout\n- Hook invocation (onEnqueueSuccess, onEnqueueError)\n```\n\n#### ShutdownManager - Missing Tests\n\n```typescript\n// Required test scenarios:\n- State transitions: 'running' -> 'graceful-shutdown' -> 'shutdown-complete'\n- getHandlersState() returns correct handler state info\n- Graceful shutdown waits for in-flight messages\n- Force shutdown after timeout\n- Multiple shutdown() calls are idempotent\n- Event handler deregistration during shutdown\n```\n\n---\n\n### Transport Module (`src/transport/`)\n\n| File                     | Has Tests | Type   | Coverage Quality |\n|--------------------------|-----------|--------|------------------|\n| local/local-transport.ts | Yes       | Unit   | Excellent        |\n| multi/multi-transport.ts | Yes       | Unit   | Good             |\n| rabbitmq/rabbitmq-transport.ts | Yes | E2E    | Good (no unit)   |\n| connection-manager.ts    | No        | -      | Missing          |\n\n#### LocalTransport - Covered Scenarios\n\n- Connection lifecycle (connect, disconnect, idempotency)\n- Capabilities reporting\n- Send/receive operations\n- Queue size tracking\n- Message completion (ack, nack, dead-letter)\n- Subscriptions (subscribe, unsubscribe, delivery)\n- Pending message delivery on subscribe\n- Dead letter queue routing\n- Topology application\n- Clear/reset functionality\n- Delayed message handling with cancellation\n\n#### MultiTransport - Covered Scenarios\n\n- Constructor validation\n- Name generation from transport names\n- Capabilities delegation to primary\n- Connection (all transports)\n- Topology application (all transports)\n- Primary transport send success\n- Fallback mechanism on primary failure\n- onEnqueueFallback hook invocation\n- All transports fail scenario\n- Sequential transport retry\n- Fallback enable/disable control\n- Subscribe from primary and fallback queues\n- Complete operation delegation\n- Dead letter delegation\n\n#### RabbitMQTransport - E2E Only (Missing Unit Tests)\n\n```typescript\n// Required unit test scenarios:\n- Channel creation per queue\n- Message encoding via codec\n- Publish confirmation handling\n- Consume callback invocation\n- Ack/nack/reject operations\n- Prefetch configuration per queue\n- Reconnection on channel close\n- Connection error handling\n- Delayed message publishing\n- Priority header handling\n```\n\n#### ConnectionManager - Missing Tests\n\n```typescript\n// Required test scenarios:\n- Initial connection establishment\n- Automatic reconnection on disconnect\n- Connection retry with backoff\n- Connection state change callbacks\n- Multiple connect() calls are idempotent\n- Graceful close() behavior\n- Error event handling\n```\n\n---\n\n### Pipeline Module (`src/pipeline/`)\n\n| File        | Has Tests | Type | Coverage Quality |\n|-------------|-----------|------|------------------|\n| pipeline.ts | No        | -    | CRITICAL Missing |\n\n#### ProcessingPipeline - Missing Tests (CRITICAL)\n\n```typescript\n// Required test scenarios:\n- Decode operation via codec\n- Subscriber lookup from registry\n- Successful callback execution\n- Callback error handling\n- Retry decision flow (shouldRetry)\n- Dead letter routing (shouldDeadLetter)\n- Requeue operation (shouldRequeue)\n- Hook invocation:\n  - onWorkerBeforeProcess\n  - onWorkerSuccess\n  - onWorkerError\n  - onDeadLetter\n  - onDecodeError\n- Message completion (ack after success)\n- Invalid message handling\n- Missing subscriber handling\n- Envelope validation\n```\n\n---\n\n### Codec Module (`src/codec/`)\n\n| File                    | Has Tests | Type | Coverage Quality |\n|-------------------------|-----------|------|------------------|\n| rabbitmq-codec.ts       | Yes       | Unit | Excellent        |\n| json-codec.ts           | No        | -    | Missing          |\n| header-aware-codec.ts   | No        | -    | Missing          |\n\n#### RabbitMQCodec - Covered Scenarios\n\n- V1 to V2 message translation (25+ fixture variations)\n- Universal metadata extraction (event_id, user_id, correlation_id)\n- Metadata merging (body + universal)\n- Header-based fields (attempt count, importance, correlation/event IDs)\n- Null field handling\n- Empty metadata\n- Nested complex data\n- Delayed message (options.delayMs)\n- Priority ordering in field resolution\n- ID generation when missing\n\n#### JsonCodec - Missing Tests\n\n```typescript\n// Required test scenarios:\n- encode() produces valid JSON Buffer\n- decode() parses JSON Buffer correctly\n- Round-trip encoding/decoding preserves data\n- Error handling for invalid JSON\n- UTF-8 encoding correctness\n- Special character handling\n```\n\n#### HeaderAwareCodec - Missing Tests\n\n```typescript\n// Required test scenarios:\n- Header extraction from message\n- Header injection into message\n- Default header handling\n- Custom header mapping\n```\n\n---\n\n### Schema Module (`src/schema/`)\n\n| File        | Has Tests | Type | Coverage Quality |\n|-------------|-----------|------|------------------|\n| registry.ts | Yes       | Unit | Excellent        |\n\n#### SchemaRegistry - Covered Scenarios\n\n- Event registration\n- Duplicate event detection\n- Override functionality\n- Event aliases (registration & retrieval)\n- Duplicate alias conflict detection\n- Event class retrieval (by key & alias)\n- Subscriber retrieval (all, by name)\n- Subscriber definition extraction\n- Executable subscriber lookup\n- Event keys listing\n- Schema validation (duplicate subscriber names)\n- Clear/reset\n\n---\n\n### Retry Module (`src/retry/`)\n\n| File               | Has Tests | Type | Coverage Quality |\n|--------------------|-----------|------|------------------|\n| standard-policy.ts | Yes       | Unit | Excellent        |\n\n#### StandardRetryPolicy - Covered Scenarios\n\n- Dead letter on EventAssertionError\n- Dead letter on DontRetry\n- Retry on DoRetry with max attempts check\n- Dead letter when max attempts exceeded\n- Non-idempotent subscriber redelivery handling\n- Idempotent subscriber redelivery\n- Generic error retry with backoff\n- Exponential backoff calculation\n- Max delay capping\n- Default configuration\n- Custom configuration\n- Partial configuration merging\n\n---\n\n### Topology Module (`src/topology/`)\n\n| File       | Has Tests | Type | Coverage Quality |\n|------------|-----------|------|------------------|\n| builder.ts | Yes       | Unit | Excellent        |\n\n#### TopologyBuilder - Covered Scenarios\n\n- Namespace configuration\n- Namespace validation (non-empty, no leading digits, hyphens/underscores allowed)\n- Queue addition (defaults, options, multiple)\n- Duplicate queue detection\n- Queue name validation (non-empty, no leading digits)\n- Concurrency validation\n- Consumer timeout validation\n- Dead letter configuration & merging\n- Retry configuration & validation\n- Disable retry\n- Disable dead letter\n- Validation without throwing\n- Immutability\n- External/exact queue marking\n\n---\n\n### Hooks Module (`src/hooks/`)\n\n| File           | Has Tests | Type | Coverage Quality |\n|----------------|-----------|------|------------------|\n| safe-hooks.ts  | No        | -    | Missing          |\n\n#### SafeHooks - Missing Tests\n\n```typescript\n// Required test scenarios:\n- Hook execution wraps errors (doesn't throw)\n- Error logging when hook fails\n- onEnqueueSuccess invocation\n- onEnqueueWarning invocation\n- onEnqueueError invocation\n- onWorkerWrap with fallback behavior\n- onWorkerBeforeProcess invocation\n- onWorkerSuccess invocation\n- onWorkerError invocation\n- onDecodeError invocation\n- onConnectionStateChange invocation\n- loadUniversalMetadata hook\n- getQueueConcurrency hook\n- getRetryDelay hook\n- getAttempts hook\n- getMaxDeliveries hook\n- isEnabled hook\n```\n\n---\n\n### Errors Module (`src/errors/`)\n\n| File               | Has Tests | Type | Coverage Quality |\n|--------------------|-----------|------|------------------|\n| matador-errors.ts  | No        | -    | Missing          |\n| retry-errors.ts    | No        | -    | Missing          |\n\n#### Error Classes - Missing Tests\n\n```typescript\n// Required test scenarios:\n- Each error type has correct name property\n- Each error has description field\n- Error message formatting\n- Error inheritance (extends MatadorError)\n- Error instanceof checks\n- SchemaError variations\n- TransportError variations\n- RetryError (DoRetry, DontRetry)\n- EventAssertionError\n```\n\n---\n\n## Integration Tests\n\n### matador.integration.test.ts - Covered Scenarios\n\n- Full event dispatch flow (dispatch -> fanout -> process -> callback)\n- Multi-event scenarios\n- Retry behavior validation\n- Graceful shutdown testing\n- State tracking validation\n\n### Missing Integration Scenarios\n\n```typescript\n// Required test scenarios:\n- Multiple concurrent dispatches\n- Dispatch during shutdown (rejection)\n- Error propagation through full stack\n- Dead letter routing end-to-end\n- Delayed message processing end-to-end\n- Priority queue ordering\n- Multi-subscriber fanout with partial failures\n```\n\n---\n\n## E2E Tests\n\n### rabbitmq-transport.e2e.test.ts - Covered Scenarios\n\n- Capabilities reporting\n- Message priority handling\n- Attempt number tracking\n- Prefetch/concurrency per queue\n- Reconnection behavior\n- Channel per queue isolation\n- Delayed messages error handling\n\n### transport-compliance.e2e.test.ts - Covered Scenarios\n\n- Common transport interface compliance\n- Send/receive basic operations\n- Subscription management\n- Dead letter handling\n\n### multi-transport.e2e.test.ts - Covered Scenarios\n\n- Primary transport usage\n- Fallback on primary failure\n- Multiple fallback transports\n- Recovery back to primary\n\n### Missing E2E Scenarios\n\n```typescript\n// Required test scenarios:\n- High-volume throughput testing\n- Network partition simulation\n- RabbitMQ restart recovery\n- Cluster failover\n- Memory pressure behavior\n- Long-running connection stability\n```\n\n---\n\n## Priority Implementation Plan\n\n### Phase 1: Critical (Core Logic)\n\n| Priority | Module             | Estimated Tests |\n|----------|--------------------|-----------------|\n| P0       | ProcessingPipeline | 15-20           |\n| P0       | FanoutEngine       | 10-12           |\n| P0       | ShutdownManager    | 8-10            |\n| P0       | SafeHooks          | 15-18           |\n\n### Phase 2: Important (Infrastructure)\n\n| Priority | Module            | Estimated Tests |\n|----------|-------------------|-----------------|\n| P1       | ConnectionManager | 8-10            |\n| P1       | RabbitMQ (unit)   | 12-15           |\n| P1       | Error Classes     | 8-10            |\n\n### Phase 3: Nice-to-Have (Completeness)\n\n| Priority | Module            | Estimated Tests |\n|----------|-------------------|-----------------|\n| P2       | JsonCodec         | 6-8             |\n| P2       | HeaderAwareCodec  | 4-6             |\n| P2       | Integration gaps  | 8-10            |\n\n---\n\n## Test Patterns to Follow\n\n### Unit Test Pattern\n\n```typescript\nimport { describe, it, expect, beforeEach, afterEach, spyOn } from 'bun:test';\n\ndescribe('ModuleName', () => {\n  let instance: ModuleClass;\n\n  beforeEach(() => {\n    instance = new ModuleClass(/* dependencies */);\n  });\n\n  afterEach(() => {\n    // cleanup\n  });\n\n  describe('methodName', () => {\n    it('should do expected behavior', () => {\n      // Arrange\n      const input = createTestInput();\n\n      // Act\n      const result = instance.methodName(input);\n\n      // Assert\n      expect(result).toEqual(expectedOutput);\n    });\n\n    it('should handle error case', () => {\n      // Arrange\n      const badInput = createBadInput();\n\n      // Act & Assert\n      expect(() => instance.methodName(badInput)).toThrow(ExpectedError);\n    });\n  });\n});\n```\n\n### Integration Test Pattern\n\n```typescript\ndescribe('Feature Integration', () => {\n  let matador: Matador;\n  let transport: LocalTransport;\n\n  beforeEach(async () => {\n    transport = new LocalTransport();\n    matador = Matador.create({ transport });\n    // register events and subscribers\n    await matador.start();\n  });\n\n  afterEach(async () => {\n    await matador.shutdown();\n  });\n\n  it('should process event through full pipeline', async () => {\n    const received: Event[] = [];\n\n    // Subscribe to capture events\n    matador.register(TestEvent, [\n      Subscriber.create({\n        name: 'test-subscriber',\n        callback: async (envelope) => {\n          received.push(envelope.data);\n        },\n      }),\n    ]);\n\n    // Dispatch\n    await matador.dispatch(new TestEvent({ value: 'test' }));\n\n    // Wait and verify\n    await waitFor(() => received.length === 1);\n    expect(received[0].value).toBe('test');\n  });\n});\n```\n\n### E2E Test Pattern\n\n```typescript\nimport { GenericContainer, StartedTestContainer } from 'testcontainers';\n\ndescribe('RabbitMQ E2E', () => {\n  let container: StartedTestContainer;\n  let transport: RabbitMQTransport;\n\n  beforeAll(async () => {\n    container = await new GenericContainer('rabbitmq:3-management')\n      .withExposedPorts(5672)\n      .start();\n  }, 60000);\n\n  afterAll(async () => {\n    await container.stop();\n  });\n\n  beforeEach(async () => {\n    transport = new RabbitMQTransport({\n      url: `amqp://localhost:${container.getMappedPort(5672)}`,\n    });\n    await transport.connect();\n  });\n\n  afterEach(async () => {\n    await transport.disconnect();\n  });\n\n  it('should handle real message flow', async () => {\n    // Test with real RabbitMQ\n  });\n});\n```\n\n---\n\n## Test Utilities to Create\n\n### Recommended Helpers\n\n```typescript\n// test/helpers/fixtures.ts\nexport function createTestEnvelope(overrides?: Partial<Envelope>): Envelope;\nexport function createTestEvent(overrides?: Partial<EventData>): Event;\nexport function createTestSubscriber(overrides?: Partial<SubscriberConfig>): Subscriber;\nexport function createTestTopology(queues?: QueueConfig[]): Topology;\nexport function createTestContext(overrides?: Partial<RetryContext>): RetryContext;\n\n// test/helpers/assertions.ts\nexport function expectEnvelopeMatch(actual: Envelope, expected: Partial<Envelope>): void;\nexport function expectErrorType(error: unknown, ErrorClass: typeof Error): void;\n\n// test/helpers/mocks.ts\nexport function createMockTransport(): Transport & { calls: Record<string, unknown[]> };\nexport function createMockCodec(): Codec & { calls: Record<string, unknown[]> };\nexport function createMockHooks(): Hooks & { invocations: string[] };\n\n// test/helpers/wait.ts\nexport async function waitFor(\n  condition: () => boolean | Promise<boolean>,\n  timeout?: number,\n  interval?: number\n): Promise<void>;\n```\n\n---\n\n## Coverage Metrics Target\n\n| Category   | Current | Target |\n|------------|---------|--------|\n| Statements | ~60%    | 90%    |\n| Branches   | ~50%    | 85%    |\n| Functions  | ~55%    | 90%    |\n| Lines      | ~60%    | 90%    |\n\n---\n\n## Summary\n\n### What We Have\n\n- Excellent coverage of: TopologyBuilder, SchemaRegistry, StandardRetryPolicy, LocalTransport, RabbitMQCodec\n- Good integration tests for core Matador flow\n- Good E2E tests for RabbitMQ transport\n\n### What We Need\n\n1. **Critical**: ProcessingPipeline, FanoutEngine, ShutdownManager, SafeHooks unit tests\n2. **Important**: ConnectionManager, RabbitMQ unit tests, Error classes\n3. **Nice-to-have**: JsonCodec, HeaderAwareCodec, additional edge cases\n\n### Next Steps\n\n1. Start with ProcessingPipeline tests (most critical gap)\n2. Add FanoutEngine tests\n3. Add ShutdownManager tests\n4. Add SafeHooks tests\n5. Add RabbitMQ unit tests\n6. Fill remaining gaps\n",
            "file_path": "/home/z/Desktop/work/matador/docs/plans/test-coverage-plan.md"
          },
          "timestamp": "2025-12-10T15:18:00.485Z"
        }
      ],
      "total_additions": 659,
      "total_deletions": 74,
      "accepted_lines": 585,
      "overriden_lines": 0
    }
  }
}
